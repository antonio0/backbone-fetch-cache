!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return a.Backbone=b(c,d)}):a.Backbone=b(a._,a.Backbone)}(this,function(a,b){function e(b,c){var d;return(d=c&&c.url?c.url:a.isFunction(b.url)?b.url():b.url)?c&&c.data?d+"?"+$.param(c.data):d:void 0}function f(a,c,d){c=c||{};var e=b.fetchCache.getCacheKey(a,c),f=!1;if(e&&c.cache!==!1&&(c.cache||c.prefill)){c.expires!==!1&&(f=(new Date).getTime()+1e3*(c.expires||300));var g=(new Date).getTime();b.fetchCache._cache[e]={expires:f,cachedOn:g,lastAccessedOn:g,value:d},b.fetchCache.setLocalStorage()}}function g(a){delete b.fetchCache._cache[a],b.fetchCache.setLocalStorage()}function h(){if(d&&b.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(b.fetchCache._cache))}catch(a){var c=a.code||a.number||a.message;if(22!==c)throw a;this._deleteCacheWithPriority()}}function i(){if(d&&b.fetchCache.localStorage){var a=localStorage.getItem("backboneCache")||"{}";b.fetchCache._cache=JSON.parse(a)}}function j(a){return window.setTimeout(a,0)}var c={modelFetch:b.Model.prototype.fetch,modelSync:b.Model.prototype.sync,collectionFetch:b.Collection.prototype.fetch},d="undefined"!=typeof window.localStorage;return b.fetchCache=b.fetchCache||{},b.fetchCache._cache=b.fetchCache._cache||{},b.fetchCache.priorityFn=function(a,b){return a&&a.expires&&b&&b.expires?a.expires-b.expires:a},b.fetchCache._prioritize=function(){var b=a.values(this._cache).sort(this.priorityFn),c=a.indexOf(a.values(this._cache),b[0]);return a.keys(this._cache)[c]},b.fetchCache._deleteCacheWithPriority=function(){b.fetchCache._cache[this._prioritize()]=null,delete b.fetchCache._cache[this._prioritize()],b.fetchCache.setLocalStorage()},"undefined"==typeof b.fetchCache.localStorage&&(b.fetchCache.localStorage=!0),b.Model.prototype.fetch=function(d){d=d||{};var e=b.fetchCache.getCacheKey(this,d),f=b.fetchCache._cache[e],g=!1,h=!1,i=new $.Deferred,k=this;return f&&(g=f.expires,g=g&&f.expires<(new Date).getTime(),h=f.value),g||!d.cache&&!d.prefill||!h||(j(function(){k.set(k.parse(h),d),a.isFunction(d.prefillSuccess)&&d.prefillSuccess(k,h,d),k.trigger("cachesync",k,h,d),k.trigger("sync",k,h,d),d.prefill?i.notify(k):(a.isFunction(d.success)&&d.success(k),i.resolve(k)),f.lastAccessedOn=(new Date).getTime(),b.fetchCache.setLocalStorage()}),d.prefill)?(c.modelFetch.apply(this,arguments).done(a.bind(i.resolve,this,this)).done(a.bind(b.fetchCache.setCache,null,this,d)).fail(a.bind(i.reject,this,this)),i.promise()):i.promise()},b.Model.prototype.sync=function(a,d){if("read"===a)return c.modelSync.apply(this,arguments);var i,j,f=d.collection,h=[];for(h.push(b.fetchCache.getCacheKey(d)),f&&h.push(b.fetchCache.getCacheKey(f)),i=0,j=h.length;j>i;i++)g(h[i]);return c.modelSync.apply(this,arguments)},b.Collection.prototype.fetch=function(d){d=d||{};var e=b.fetchCache.getCacheKey(this,d),f=b.fetchCache._cache[e],g=!1,h=!1,i=new $.Deferred,k=this;return f&&(g=f.expires,g=g&&f.expires<(new Date).getTime(),h=f.value),g||!d.cache&&!d.prefill||!h||(j(function(){k[d.reset?"reset":"set"](k.parse(h),d),a.isFunction(d.prefillSuccess)&&d.prefillSuccess(k),k.trigger("cachesync",k,h,d),k.trigger("sync",k,h,d),d.prefill?i.notify(k):(a.isFunction(d.success)&&d.success(k),i.resolve(k)),f.lastAccessedOn=(new Date).getTime(),b.fetchCache.setLocalStorage()}),d.prefill)?(c.collectionFetch.apply(this,arguments).done(a.bind(i.resolve,this,this)).done(a.bind(b.fetchCache.setCache,null,this,d)).fail(a.bind(i.reject,this,this)),i.promise()):i.promise()},i(),b.fetchCache._superMethods=c,b.fetchCache.setCache=f,b.fetchCache.getCacheKey=e,b.fetchCache.clearItem=g,b.fetchCache.setLocalStorage=h,b.fetchCache.getLocalStorage=i,b});